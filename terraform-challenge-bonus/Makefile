.PHONY: help init validate fmt plan apply destroy clean test outputs

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘    Challenge Terraform AvancÃ© - Commandes Disponibles     â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "  init         : Initialise Terraform"
	@echo "  validate     : Valide la syntaxe Terraform"
	@echo "  fmt          : Formate le code Terraform"
	@echo "  plan         : Affiche le plan de dÃ©ploiement"
	@echo "  apply        : DÃ©ploie l'infrastructure"
	@echo "  outputs      : Affiche les outputs"
	@echo "  test         : Teste les services dÃ©ployÃ©s"
	@echo "  destroy      : DÃ©truit l'infrastructure"
	@echo "  clean        : Nettoie les fichiers Terraform"
	@echo "  all          : Workflow complet (init + validate + apply)"
	@echo ""

init:
	@echo "ğŸ”§ Initialisation de Terraform..."
	/opt/homebrew/bin/terraform init

validate:
	@echo "âœ“ Validation du code Terraform..."
	/opt/homebrew/bin/terraform validate

fmt:
	@echo "ğŸ“ Formatage du code..."
	/opt/homebrew/bin/terraform fmt -recursive

plan:
	@echo "ğŸ“‹ CrÃ©ation du plan..."
	/opt/homebrew/bin/terraform plan

apply:
	@echo "ğŸš€ DÃ©ploiement de l'infrastructure..."
	/opt/homebrew/bin/terraform apply -auto-approve
	@echo ""
	@echo "âœ… DÃ©ploiement terminÃ© !"
	@echo ""
	@make outputs

outputs:
	@echo "ğŸ“Š Outputs du dÃ©ploiement:"
	@echo ""
	@/opt/homebrew/bin/terraform output
	@echo ""
	@echo "ğŸŒ URLs d'accÃ¨s rapide:"
	@/opt/homebrew/bin/terraform output -json quick_access_urls | jq -r '.[]'

test:
	@echo "ğŸ§ª Tests des services dÃ©ployÃ©s..."
	@echo ""
	@echo "1ï¸âƒ£  Containers actifs:"
	@docker ps --filter label=managed_by=terraform --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "2ï¸âƒ£  RÃ©seau:"
	@docker network ls --filter label=managed_by=terraform --format "table {{.Name}}\t{{.Driver}}\t{{.Scope}}"
	@echo ""
	@echo "3ï¸âƒ£  Volumes:"
	@docker volume ls --filter label=managed_by=terraform --format "table {{.Name}}\t{{.Driver}}"
	@echo ""
	@echo "4ï¸âƒ£  Test HTTP des services publics:"
	@/opt/homebrew/bin/terraform output -json service_ports_mapping | jq -r 'to_entries[] | "curl -s -o /dev/null -w \"[\(.key)] HTTP \(.value): %{http_code}\\n\" http://localhost:\(.value)"' | while read cmd; do eval $$cmd || echo "Service inaccessible"; done
	@echo ""

destroy:
	@echo "ğŸ—‘ï¸  Destruction de l'infrastructure..."
	/opt/homebrew/bin/terraform destroy -auto-approve
	@echo "âœ… Infrastructure dÃ©truite"

clean: destroy
	@echo "ğŸ§¹ Nettoyage des fichiers Terraform..."
	rm -rf .terraform
	rm -f .terraform.lock.hcl
	rm -f terraform.tfstate*
	@echo "âœ… Nettoyage terminÃ©"

all: init validate fmt apply test
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘         ğŸ‰ DÃ©ploiement complet rÃ©ussi ! ğŸ‰                â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
